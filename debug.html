<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvaraTap Debug Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .debug-panel {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }
        .status {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .online { background: #2d5a2d; color: #4ade80; }
        .offline { background: #5a2d2d; color: #f87171; }
        pre {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .error { color: #f87171; }
        .success { color: #4ade80; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>🔧 EvaraTap Debug Dashboard</h1>
    
    <div class="status" id="connectionStatus">🔄 Checking connection...</div>
    
    <div class="debug-panel">
        <h2>🧪 Connection Tests</h2>
        <button onclick="testNetlifyProxy()">Test Netlify MQTT Proxy</button>
        <button onclick="testDirectAdafruitIO()">Test Direct Adafruit IO</button>
        <button onclick="testFeeds()">List All Feeds</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="debug-panel">
        <h2>📡 Raw ESP32 Data</h2>
        <pre id="esp32Data">No data yet...</pre>
    </div>
    
    <div class="debug-panel">
        <h2>📋 Debug Log</h2>
        <pre id="debugLog">Debug log will appear here...</pre>
    </div>

    <script>
        const AIO_USERNAME = 'ADI08';
        const AIO_KEY = 'YOUR_ADAFRUIT_IO_KEY_HERE';
        
        const log = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        };
        
        const clearLog = () => {
            document.getElementById('debugLog').innerHTML = '';
            document.getElementById('esp32Data').textContent = 'Cleared...';
        };
        
        // Test Netlify MQTT Proxy
        const testNetlifyProxy = async () => {
            log('🧪 Testing Netlify MQTT Proxy...', 'info');
            try {
                const response = await fetch('/api/mqtt-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_system_status' })
                });
                
                log(`📡 Proxy Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const result = await response.json();
                    log('✅ Proxy working! Data received:', 'success');
                    log(JSON.stringify(result, null, 2), 'info');
                    
                    document.getElementById('esp32Data').textContent = JSON.stringify(result, null, 2);
                    
                    if (result.data?.esp32) {
                        updateConnectionStatus(true, 'Netlify Proxy');
                    } else {
                        updateConnectionStatus(false, 'Netlify Proxy (No ESP32 data)');
                    }
                } else {
                    const errorText = await response.text();
                    log(`❌ Proxy failed: ${errorText}`, 'error');
                    updateConnectionStatus(false, 'Netlify Proxy Error');
                }
            } catch (error) {
                log(`❌ Proxy test failed: ${error.message}`, 'error');
                updateConnectionStatus(false, 'Netlify Proxy Unreachable');
            }
        };
        
        // Test Direct Adafruit IO API
        const testDirectAdafruitIO = async () => {
            log('🧪 Testing Direct Adafruit IO API...', 'info');
            try {
                const feedUrl = `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/esp32-data/data/last`;
                const response = await fetch(feedUrl, {
                    headers: { 'X-AIO-Key': AIO_KEY }
                });
                
                log(`📡 Adafruit IO Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Direct API working! Raw feed data:', 'success');
                    log(JSON.stringify(data, null, 2), 'info');
                    
                    if (data.value) {
                        const parsedValue = JSON.parse(data.value);
                        const processedData = {
                            ...parsedValue,
                            last_updated: data.created_at
                        };
                        
                        log('📦 Processed ESP32 data:', 'success');
                        log(JSON.stringify(processedData, null, 2), 'info');
                        
                        document.getElementById('esp32Data').textContent = JSON.stringify(processedData, null, 2);
                        
                        if (processedData.device_heartbeat) {
                            updateConnectionStatus(true, 'Direct Adafruit IO');
                        } else {
                            updateConnectionStatus(false, 'Direct API (No heartbeat)');
                        }
                    }
                } else {
                    const errorText = await response.text();
                    log(`❌ Adafruit IO failed: ${errorText}`, 'error');
                    updateConnectionStatus(false, 'Adafruit IO Error');
                }
            } catch (error) {
                log(`❌ Direct API test failed: ${error.message}`, 'error');
                updateConnectionStatus(false, 'Adafruit IO Unreachable');
            }
        };
        
        // Test listing all feeds
        const testFeeds = async () => {
            log('🧪 Testing feed listing...', 'info');
            try {
                const feedsUrl = `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds`;
                const response = await fetch(feedsUrl, {
                    headers: { 'X-AIO-Key': AIO_KEY }
                });
                
                if (response.ok) {
                    const feeds = await response.json();
                    log(`✅ Found ${feeds.length} feeds:`, 'success');
                    feeds.forEach(feed => {
                        log(`  📊 ${feed.name} (${feed.key}) - Last: ${feed.last_value || 'None'}`, 'info');
                    });
                } else {
                    log(`❌ Feed listing failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ Feed test failed: ${error.message}`, 'error');
            }
        };
        
        const updateConnectionStatus = (isOnline, source) => {
            const statusEl = document.getElementById('connectionStatus');
            if (isOnline) {
                statusEl.textContent = `🟢 ONLINE (via ${source})`;
                statusEl.className = 'status online';
            } else {
                statusEl.textContent = `🔴 OFFLINE (${source})`;
                statusEl.className = 'status offline';
            }
        };
        
        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 EvaraTap Debug Dashboard Started', 'info');
            setTimeout(() => {
                testNetlifyProxy();
                setTimeout(() => testDirectAdafruitIO(), 2000);
            }, 1000);
        });
        
        // Auto-refresh every 10 seconds
        setInterval(() => {
            log('🔄 Auto-refresh...', 'info');
            testDirectAdafruitIO();
        }, 10000);
    </script>
</body>
</html>