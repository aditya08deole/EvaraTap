<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvaraTap Flow Control System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); 
            color: #333; 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .subtitle { font-size: 1.2rem; opacity: 0.9; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }
        .card { 
            background: rgba(255,255,255,0.95); 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
        }
        .card-title { 
            font-size: 1.5rem; 
            margin-bottom: 15px; 
            color: #2c3e50; 
            text-align: center; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
        }
        .gauge-wrapper { position: relative; width: 100%; margin: 0 auto; }
        .gauge-container { position: relative; width: 100%; height: 200px; margin: 0 auto; }
        .gauge-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .gauge-text { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .gauge-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .gauge-label { font-size: 1.2rem; color: #7f8c8d; }
        .stats { display: flex; justify-content: space-around; margin-top: 20px; text-align: center; }
        .stat-item { padding: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 1rem; color: #7f8c8d; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 50px; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        .btn-open { background: linear-gradient(to right, #2ecc71, #27ae60); color: white; }
        .btn-close { background: linear-gradient(to right, #e74c3c, #c0392b); color: white; }
        .btn-reset { background: linear-gradient(to right, #3498db, #2980b9); color: white; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 7px 10px rgba(0,0,0,0.2); }
        .status-indicator { display: inline-block; width: 15px; height: 15px; border-radius: 50%; margin-right: 8px; }
        .status-open { background-color: #2ecc71; }
        .status-closed { background-color: #e74c3c; }
        .system-status { text-align: center; padding: 10px; margin-top: 20px; border-radius: 5px; font-weight: bold; }
        .system-status.normal { background-color: #d4edda; color: #155724; }
        .system-status.limit-reached { background-color: #f8d7da; color: #721c24; }
        .system-status.offline { background-color: #f8d7da; color: #721c24; }
        .settings-panel { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .device-status-indicator {
            position: absolute; top: 15px; right: 20px; padding: 5px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;
            background-color: #2ecc71; color: white;
        }
        .device-status-indicator.offline { background-color: #e74c3c; }
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 10px; color: white; font-weight: 600; z-index: 1000; transition: all 0.5s ease; }
        .toast-notification.show { bottom: 20px; }
        .toast-notification.success { background-color: #2ecc71; }
        .toast-notification.error { background-color: #e74c3c; }
        @media (max-width: 768px) {
            .gauge-container { height: 180px; }
            .gauge-value { font-size: 2rem; }
            .gauge-label { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EvaraTap Flow Control System</h1>
            <p class="subtitle">Advanced Water Management with Volume Control</p>
        </header>
        <div class="dashboard">
            <!-- Volume Gauge Card -->
            <div class="card">
                <div id="valveControllerStatus" class="device-status-indicator offline">Offline</div>
                <h2 class="card-title">Total Volume</h2>
                <div class="gauge-wrapper">
                    <div class="gauge-container">
                        <canvas id="volumeGauge" class="gauge-canvas"></canvas>
                        <div class="gauge-text">
                            <div class="gauge-value" id="totalVolumeGauge">0.0</div>
                            <div class="gauge-label">Liters</div>
                        </div>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="flowRate">0.0</div>
                        <div class="stat-label">Flow Rate (L/min)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            <span class="status-indicator" id="valveStatusIndicator"></span>
                            <span id="valveStatus">UNKNOWN</span>
                        </div>
                        <div class="stat-label">Valve Status</div>
                    </div>
                </div>
                <div class="system-status" id="systemStatusMessage">System Status</div>
            </div>

            <!-- Control Card -->
            <div class="card">
                <h2 class="card-title">System Controls</h2>
                <div class="controls" id="controlButtons">
                    <button class="btn btn-open" data-command="open">Open Valve</button>
                    <button class="btn btn-close" data-command="close">Close Valve</button>
                    <button class="btn btn-reset" data-command="reset">Reset System</button>
                </div>

                <div class="settings-panel">
                    <h3>Volume Limit Settings</h3>
                    <div class="input-group">
                        <label for="volumeLimitInput">Volume Limit (Liters)</label>
                        <input type="number" id="volumeLimitInput" min="1" step="0.5" value="100.0">
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="autoShutoff" checked> Enable Auto Shutoff
                        </label>
                    </div>
                    <button class="btn" onclick="saveSettings()" style="background:#3498db;color:white;width:100%;">Save Settings</button>
                </div>

                <div class="stats" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="stat-value" id="sessionVolume">0.0 L</div>
                        <div class="stat-label">Session Volume</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="volumeLimit">100.0 L</div>
                        <div class="stat-label">Volume Limit</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast-notification"></div>
    
    <script>
        const MQTT_PROXY_ENDPOINT = "/api/mqtt-proxy";
        const STATUS_REFRESH_INTERVAL = 3000;
        const MAX_DATA_AGE_SECONDS = 15;

        let systemState = { esp_data: null, isCommandPending: false };
        let statusIntervalId = null; 

        const ui = {};

        const showToast = (message, type = 'error') => {
            ui.toast.textContent = message;
            ui.toast.className = `toast-notification ${type} show`;
            setTimeout(() => {
                ui.toast.className = 'toast-notification';
            }, 3000);
        };

        const formatTimeAgo = (isoString) => {
            if (!isoString) return "Never";
            const seconds = Math.round((new Date() - new Date(isoString)) / 1000);
            if (seconds < 5) return "Just now";
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        };

        const isDeviceOnline = (data) => {
            const isStale = !data || !data.last_updated || (new Date() - new Date(data.last_updated)) / 1000 > MAX_DATA_AGE_SECONDS;
            if (isStale) return false;
            return data.device_heartbeat === true;
        };

        const updateUI = () => {
            const deviceOnline = isDeviceOnline(systemState.esp_data);
            updateDeviceStatusIndicator(deviceOnline);
            updateValvePanel(deviceOnline);
        };

        const updateDeviceStatusIndicator = (isOnline) => {
            ui.valveControllerStatus.textContent = isOnline ? 'Online' : 'Offline';
            ui.valveControllerStatus.className = `device-status-indicator ${isOnline ? 'online' : 'offline'}`;
        };

        let volumeChart = null;

        const createVolumeGauge = () => {
            const canvas = document.getElementById('volumeGauge');
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            const ctx = canvas.getContext('2d');
            
            if (volumeChart) {
                volumeChart.destroy();
            }

            const data = systemState.esp_data;
            const currentVolume = data ? (data.total_volume_liters || 0) : 0;
            const volumeLimit = data ? (data.volume_limit_liters || 100) : 100;
            const remainingVolume = Math.max(0, volumeLimit - currentVolume);

            volumeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [currentVolume, remainingVolume],
                        backgroundColor: [
                            currentVolume > volumeLimit * 0.8 ? '#e74c3c' : '#3498db',
                            '#ecf0f1'
                        ],
                        borderWidth: 0,
                        borderRadius: 5,
                        circumference: 180,
                        rotation: -90
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    maintainAspectRatio: false
                }
            });
        };

        const updateValvePanel = (isOnline) => {
            const data = systemState.esp_data;
            const isSensorLockout = isOnline && data && data.sensor_lockout === true;
            const isLimitReached = isOnline && data && data.limit_reached === true;

            const buttonsDisabled = !isOnline || isSensorLockout;
            ui.controlButtons.querySelectorAll('button').forEach(btn => btn.disabled = buttonsDisabled);

            // Update system status message
            let statusMessage = 'System Status';
            let statusClass = 'system-status normal';
            
            if (!isOnline) {
                statusMessage = 'Device Offline - No Connection';
                statusClass = 'system-status offline';
            } else if (isSensorLockout) {
                statusMessage = 'Sensor Lockout - Check Flow Sensor Connection';
                statusClass = 'system-status limit-reached';
            } else if (isLimitReached) {
                statusMessage = 'Volume limit reached - valve closed automatically';
                statusClass = 'system-status limit-reached';
            } else {
                statusMessage = 'System operating normally';
                statusClass = 'system-status normal';
            }
            
            ui.systemStatusMessage.textContent = statusMessage;
            ui.systemStatusMessage.className = statusClass;

            // Update valve status with indicator
            if (systemState.isCommandPending) {
                ui.valveStatus.textContent = 'Pending...';
                ui.valveStatusIndicator.className = 'status-indicator';
            } else {
                const valveOpen = isOnline && data && data.valve_state === 'ON';
                ui.valveStatus.textContent = isOnline && data ? data.valve_state || 'UNKNOWN' : 'UNKNOWN';
                ui.valveStatusIndicator.className = `status-indicator ${valveOpen ? 'status-open' : 'status-closed'}`;
            }

            // Update flow rate
            ui.flowRate.textContent = isOnline && data && data.flow_rate_lpm !== undefined ? 
                data.flow_rate_lpm.toFixed(1) : '0.0';

            // Update volumes
            const totalVol = isOnline && data && data.total_volume_liters !== undefined ? 
                data.total_volume_liters.toFixed(1) : '0.0';
            const sessionVol = isOnline && data && data.volume_since_open !== undefined ? 
                data.volume_since_open.toFixed(1) : '0.0';
            const volLimit = isOnline && data && data.volume_limit_liters !== undefined ? 
                data.volume_limit_liters.toFixed(1) : '100.0';

            ui.totalVolumeGauge.textContent = totalVol;
            ui.sessionVolume.textContent = sessionVol + ' L';
            ui.volumeLimit.textContent = volLimit + ' L';

            // Update volume limit input
            if (isOnline && data && data.volume_limit_liters !== undefined) {
                ui.volumeLimitInput.value = data.volume_limit_liters.toFixed(1);
            }

            // Update auto shutoff checkbox
            if (isOnline && data && data.auto_shutoff_enabled !== undefined) {
                ui.autoShutoff.checked = data.auto_shutoff_enabled;
            }

            createVolumeGauge();
        };

        const handleCommand = async (command) => {
            clearInterval(statusIntervalId);
            systemState.isCommandPending = true;
            ui.controlButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);
            updateUI(); 

            try {
                const response = await fetch(MQTT_PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'send_valve_command', payload: command })
                });
                if (!response.ok) {
                    const errorDetails = (await response.json()).details || `HTTP ${response.status}`;
                    throw new Error(errorDetails);
                }
                showToast(`${command.toUpperCase()} command sent successfully.`, 'success');
                setTimeout(getSystemStatus, 500);
            } catch (error) {
                showToast(`Command failed: ${error.message}`, 'error');
                systemState.isCommandPending = false;
                updateUI();
            } finally {
                statusIntervalId = setInterval(getSystemStatus, STATUS_REFRESH_INTERVAL);
            }
        };

        const getSystemStatus = async () => {
            try {
                const response = await fetch(MQTT_PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_system_status' })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ details: `Server returned an error: ${response.status}` }));
                    throw new Error(err.details);
                }
                const result = await response.json();
                systemState.esp_data = result.data.esp_data;
                systemState.isCommandPending = false;
            } catch (error) {
                console.error("Failed to get system status:", error.message);
                systemState.esp_data = null;
            }
            updateUI();
        };

        const saveSettings = () => {
            const volumeLimit = parseFloat(ui.volumeLimitInput.value);
            const autoShutoff = ui.autoShutoff.checked;
            
            const settingsCommand = {
                volume_limit: volumeLimit,
                auto_shutoff: autoShutoff
            };
            
            handleCommand(settingsCommand);
        };

        document.addEventListener('DOMContentLoaded', () => {
            ui.toast = document.getElementById('toast');
            ui.valveControllerStatus = document.getElementById('valveControllerStatus');
            ui.systemStatusMessage = document.getElementById('systemStatusMessage');
            ui.valveStatus = document.getElementById('valveStatus');
            ui.valveStatusIndicator = document.getElementById('valveStatusIndicator');
            ui.flowRate = document.getElementById('flowRate');
            ui.totalVolumeGauge = document.getElementById('totalVolumeGauge');
            ui.sessionVolume = document.getElementById('sessionVolume');
            ui.volumeLimit = document.getElementById('volumeLimit');
            ui.volumeLimitInput = document.getElementById('volumeLimitInput');
            ui.autoShutoff = document.getElementById('autoShutoff');
            ui.controlButtons = document.getElementById('controlButtons');

            ui.controlButtons.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                    handleCommand(e.target.dataset.command);
                }
            });

            // Make saveSettings globally available
            window.saveSettings = saveSettings;

            getSystemStatus();
            statusIntervalId = setInterval(getSystemStatus, STATUS_REFRESH_INTERVAL);
        });
    </script>
</body>
</html>